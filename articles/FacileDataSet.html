<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FacileDataSet Overview • FacileData</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="FacileDataSet Overview">
<meta property="og:description" content="FacileData">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">FacileData</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.98.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/FacileData.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/FacileDataSet-architecture.html">FacileDataSet Architecture</a>
    </li>
    <li>
      <a href="../articles/FacileDataSet-assembly.html">FacileDataSet Assembly</a>
    </li>
    <li>
      <a href="../articles/FacileDataSet.html">FacileDataSet Overview</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/facilebio/FacileData/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="FacileDataSet_files/header-attrs-2.9/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>FacileDataSet Overview</h1>
                        <h4 class="author">Steve Lianoglou</h4>
            
            <h4 class="date">2021-06-27</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/facilebio/FacileData/blob/master/vignettes/FacileDataSet.Rmd"><code>vignettes/FacileDataSet.Rmd</code></a></small>
      <div class="hidden name"><code>FacileDataSet.Rmd</code></div>

    </div>

    
    
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h1>
<p>The <code>FacileDataSet</code> is a reference implementation of a multi-assay datastore that implements the <em>FacileData</em> API. It uses a SQLite database to store feature- and sample-level metadata, and an HDF5 file to store any number of assays over its samples. Both of these technologies allow quick and efficient access to arbitrary subsets of data stored on disk without having to load all of the data into RAM, making this datastore ideal for housing data like <em>the entirety</em> of the data from <a href="https://cancergenome.nih.gov/">The Cancer Genome Atlas</a>.</p>
<p>This document first shows you how to create a <code>FacileDataSet</code>, and later gets into the design and implentation details of the <code>FacileDataSet</code>. These details are helpful to understand its performance characterstics (which are awesome), and how you might go about tweaking/improving them.</p>
<p><strong>Warning:</strong> Once you get start to use a <code>FacileDataSet</code>, you will find it hard to go back to “the normal way” of doing this!</p>
</div>
<div id="faciledataset-creation" class="section level1">
<h1 class="hasAnchor">
<a href="#faciledataset-creation" class="anchor"></a>FacileDataSet Creation</h1>
<p>The easiest way to create a <code>FacileDataSet</code> is to pass a list of <a href="#well-groomed-datasets">well-groomed</a> <code>list</code> of <code>SummarizedExperiment</code>s (or <code>ExpressionSet</code>s) to the <code>as.FacileDataSet</code> function.</p>
<p>A <code>FacileDataSet</code> is stored on disk as a well-structured directory. You can look at the <a href="#faciledataset-architecture">FacileDataSet Architecture</a> section for the full details, but the important information to know is that:</p>
<ol style="list-style-type: decimal">
<li>The dense assay matrices of the <code>SummarizedExperiment</code> are stored in an HDF5 file.</li>
<li>Feature (row) and sample (column) metadata (<code>fData</code> and <code>pData</code>, respectively) are stored in an SQLite database.</li>
<li>The <code>pData</code>/<code>colData</code> data.frames of each <code>SummarizedExperiment</code> are stored in an SQLite table in an entity-attribute-value-table (EAV) format in order to support covariates that are both common to all <code>SummarizedExperiment</code>s and unique to others.</li>
<li>There is a <code>meta.yaml</code> file that stores important information about the dataset itself. Perhaps most important is the <code>sample_covariates</code> section that dictates how each covariate stored in the EAV table is decoded back into its native R-representation. More details are provided in the <a href="#entity-attribute-value-table">Entity-Attribute-Value Table</a> section.</li>
</ol>
<div id="well-groomed-datasets" class="section level2">
<h2 class="hasAnchor">
<a href="#well-groomed-datasets" class="anchor"></a>Well Groomed Datasets</h2>
<p>A FacileDataSet generally contains two or more facets, or related data collections. For example facets may be the various tissue data sets from the TCGA or a various clinical trial for a the same drug. A FacileDataSet should be prepared as a <em>named</em> list of <code>SummarizedExperiment</code>s or a <em>named</em> list of <code>ExpressionSets</code>. It is expected that these objects will share some, but not necessarily all, of their sample annotation columns (<code>colData</code> or <code>pData</code>). Columns with the same names should also have the same encoding, factor levels, etc.</p>
<p>Annotations on the <code>SummarizedExperiment</code>s themselves and on the <code>colData</code> columns are also used to fill out the meta.yaml file described above.</p>
<p><code>ExpressionSet</code> pData <code>data.frames</code> should have an attribute named ‘label’, which will be a named character vector with a description for each column. In the case of a <code>SummarizedExperiment</code>, the <code>colData</code> should have named list in the <code>metadata</code> slot with a character description of each column.</p>
<p><code>ExpressionSet</code>s should have a short textual description of the facet/dataset in the <code>annotation</code> slot. Similarly, <code>SummarizedExperiment</code>s should have a list in the <code>metadata</code> slot with <code>url</code> and <code>description</code> for the facet/dataset.</p>
<p>The <code>fData</code> or <code>mcols</code> for the <code>ExpressionSet</code> or <code>SummarizedExperiment</code>, respectively, should have <code>feature_type</code>, <code>feature_id</code>, <code>name</code>, <code>meta</code>, <code>effective_length</code> and <code>source</code> columns. See the manpage for <code>as.FacileDataSet</code> for more details.</p>
<div id="well-groomed-pdata" class="section level3">
<h3 class="hasAnchor">
<a href="#well-groomed-pdata" class="anchor"></a>Well Groomed pData</h3>
<p>Given a list of <code>SummarizedExperiment</code>s, we collect the individual <code>pData()</code>/<code>mcols()</code>. When <code><a href="https://rdrr.io/r/base/colnames.html">colnames()</a></code> match across these <code>data.frame</code>s, we assume that the covariates <em>mean the same thing</em> and are <em>encoded using the same scheme</em> (ie. factor levels match).</p>
<p>Where <code><a href="https://rdrr.io/r/base/colnames.html">colnames()</a></code> differ between <code>pData</code> <code>data.frame</code>s, even if it is just by a single letter, or their case, are treated as being different.</p>
</div>
</div>
</div>
<div id="faciledataset-architecture" class="section level1">
<h1 class="hasAnchor">
<a href="#faciledataset-architecture" class="anchor"></a>FacileDataSet Architecture</h1>
<div id="hybrid-data-storage" class="section level2">
<h2 class="hasAnchor">
<a href="#hybrid-data-storage" class="anchor"></a>Hybrid Data Storage</h2>
<p>The <code>FacileDataSet</code> stores the following data:</p>
<ol style="list-style-type: decimal">
<li>A <code>data.sqlite</code> SQLite database that stores feature- and sample-level metadata.</li>
<li>A <code>data.h5</code> HDF5 file that stores a multitude of dense assay matrices that are generated from the assays performed on the samples in the <code>FacileDataSet</code>.</li>
<li>A <code>meta.yaml</code> file tha contains information about the <code>FacileDataSet</code>. To better understand the structure and contents of this file, you can refer to the following:
<ol style="list-style-type: lower-alpha">
<li>The included <code>testdata/expected-meta.yaml</code> file for, which is an exemplar file for the <code>testdata/TestFacileTcgaDataSet</code>, which consists of data extracted from two datasets (BLCA and BRCA) from the TCGA.</li>
<li>The help file provided by the <code>eav_metadata_create</code> function, which describes in greater detail how we track a dataset’s sample-level covariates (aka, “pData” in the bioconductor world). In the meantime, a short description of the entries found in the <code>meta.yaml</code> file is provided here:</li>
</ol>
<ul>
<li>
<code>name</code>: the name of the dataset (i.e. <code>"FacileTCGADataSet"</code>)</li>
<li>
<code>organism</code>: <code>"Homo sapiens"</code>, <code>"Mus musculus"</code>, etc.</li>
<li>
<code>default_assay</code>: the name of the assay to use by default if none is specified in calls to [fetch_assay_data()], [with_assay_data()], etc. (kind of like how <code>"exprs"</code> is the default assay used when working with a [Biobase::ExpressionSet])</li>
<li>
<code>datasets</code>: a section tha enumerates the datasets included internally. The datasets are further enumerated.</li>
<li>
<code>sample_covariates</code>: a section that enumerates the covariates that are tracked over the samples inside the <code>FacileDataSet</code> (ie. a mapping of the <code>pData</code> for the samples). Reference <code>?create_eav_metadata</code> for more information.</li>
</ul>
</li>
<li>A <code>custom-annotation</code> directory, which stores custom <code>sample_covariate</code> (aka “pData”) information that analysts can identify and describe during the course of an analysis, or even add from external sources. Although this directory is required in the directory structure of a valid <code>FacileDataSet</code>, the <code><a href="../reference/FacileDataSet.html">FacileDataSet()</a></code> constructor can be called with a custom <code>anno.dir</code> parameter so that custom annotations are stored elsewhere.</li>
</ol>
<div id="sqlite-schema" class="section level3">
<h3 class="hasAnchor">
<a href="#sqlite-schema" class="anchor"></a>SQLite Schema</h3>
</div>
<div id="entity-attribute-value-table" class="section level3">
<h3 class="hasAnchor">
<a href="#entity-attribute-value-table" class="anchor"></a>Entity-Attribute-Value Table</h3>
<p>Sample covariates (aka <code>pData</code>) are encoded in an [entity-attribute-value (EAV) table][EAV]. Metadata about these covariates are stored in a <code>meta.yaml</code> file in the <code>FacileDataSet</code> directory which enables the <code>FacileDataSet</code> to cast the value stored in the EAV table to its native R type. This function generates the list-of-list structure to represent the <code>sample_covariates</code> section of the <code>meta.yaml</code> file.</p>
<p>For simple <code>pData</code> covariates, each column is treated independently from the rest. There are some types of covariates which require multiple columns for proper encoding, such as encoding of survival information, which requires a pair of values that indicate the “time to event” and the status of the event (death or censored). In these cases, the caller needs to provide an entry in the <code>covariate_def</code> list that describes which <code>pData</code> columns (<code>varname</code>) goes into the single facile covariate value.</p>
<p>Please refer to the <strong>Encoding Survival Covariates</strong> section for a more detailed description of how to define encoding survival information into the EAV table using the <code>covariate_def</code> parameter. Further examples of how to encode other complex atributes will be added as they are required, but you can reference the <strong>Encoding Arbitrarily Complex Covariates</strong> section for some more information.</p>
</div>
<div id="encoding-survival-covariates" class="section level3">
<h3 class="hasAnchor">
<a href="#encoding-survival-covariates" class="anchor"></a>Encoding Survival Covariates:</h3>
<p><em>UPDATE:</em> Survival covariates can now be encoded simply as a <code><a href="https://rdrr.io/pkg/survival/man/Surv.html">survival::Surv</a></code> object and provided as a column in the pData data.frame. The following describes the original, and still supported, method.</p>
<p>Survival data in R is typically encoded by two vectors. One vector that indicates the “time to event” (tte), and a second to indicate whether or not the denoted tte is an “event” (1) or “censored” (0).</p>
<p>Normally these vectors appear as two columns in an experiment’s <code>pData</code>, and therefore need to be encoded into the <code>FacileDataSet</code>’s EAV table. To do so, the pair of vectors are turned into a signed numeric value. The absolute value of the numeric indicates the “time to event” and the sign of the value indicates its censoring status.</p>
<p>Let’s assume we have <code>tte_OS</code> and <code>event_OS</code> column that are used to encode a patient’s overall survival (time and censor status). To store this as an “OS” covariate in the EAV table, a <code>covariate_def</code> list-of-list definition that captures this encoding would look like this:</p>
<pre><code>covariate_def &lt;- list(
  OS=list(
    class="right_censored",
    arguments=c(time="tte_OS", event="event_OS"),
    label="Overall Survival",
    type="clinical",
    description="Overall survival in days"))</code></pre>
<p>Note how the name of the list-entry in <code>covariate_def</code> defines the name of the covariate in the <code>FacileDataSet</code>. The <code>class</code> entry for the <code>OS</code> definition indicates the type of variable this is. The <code>varname</code> entry lists the columns in the <code>pData</code> that are combined to make this value. The <code><a href="https://rdrr.io/r/base/names.html">names(varnames)</a></code> correspond to the parameters in the [eav_encode_right_censored()] function. The analagous <code>meta.yaml</code> entry in the <code>sample_covariates</code> section for the <code>"OS"</code> <code>covariate_def</code> entry looks like so:</p>
<pre><code>sample_covariates:
  OS:
    class: right_censored
    label: "Overall Survival"
    type: "clinical"
    description: "Overall survival in days"
    colnames: ["tte_OS", "event_OS"]
    argnames: ["time", "event"]</code></pre>
</div>
<div id="encoding-arbitrarily-complex-covariates" class="section level3">
<h3 class="hasAnchor">
<a href="#encoding-arbitrarily-complex-covariates" class="anchor"></a>Encoding Arbitrarily Complex Covariates:</h3>
<p>To encode a new type of complex covariate from a wide <code>pData</code> data.frame, we need to:</p>
<ol style="list-style-type: decimal">
<li>Specify a new <code>class</code> (like <code>"right_censored"</code>) for use within a <code>FacileDataSet</code>.</li>
<li>Define an <code>eav_encode_&lt;class&gt;(arg1, arg2, ...)</code> function which takes the R data vectors (arg1, arg2) and converts them into a single value for the EAV table.</li>
<li>Define a <code>eav_decode_&lt;class&gt;(x, attrname, def, ...)</code> function which takes the single value in the EAV table and casts it back into the R-native data vector(s).
<ul>
<li>
<code>x</code> is the vector of (character) values from the EAV table</li>
<li>
<code>attrname</code> is the name of the covariate in the EAV table</li>
<li>
<code>def</code> is the definition-list for this covariate.</li>
<li>
<code>...</code> allows each decode function to be further customized. [EAV]: <a href="https://en.wikipedia.org/wiki/Entity-attribute-value_model" class="uri">https://en.wikipedia.org/wiki/Entity-attribute-value_model</a>
</li>
</ul>
</li>
</ol>
</div>
<div id="hdf5-file-assay-data" class="section level3">
<h3 class="hasAnchor">
<a href="#hdf5-file-assay-data" class="anchor"></a>HDF5 File Assay Data</h3>
<p>The HDF5 file has one directory per assay. These directories have one matrix per dataset for the given assay.</p>
<p>For instance, the <code>FacileTCGADataSet</code> HDF5 file has this structure:</p>
<pre><code>. data.h5
├── rnaseq
│   ├── ACC
│   ├── BLCA
│   ├── BRCA
│   ├── CESC
│   ├── ...
├── cnv_score
│   ├── ACC
│   ├── BLCA
│   ├── BRCA
│   ├── CESC
│   ├── ...
├── mirnaseq
│   ├── ACC
│   ├── BLCA
│   ├── BRCA
│   ├── CESC
│   ├── ...</code></pre>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Steve Lianoglou, Vincent Rouilly, Peter Haverty, Denali Therapeutics, Genentech.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
